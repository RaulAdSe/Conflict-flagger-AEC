# Session Notes - January 11, 2025

## Branch: `actualitzacio_app_comparator`

This document summarizes the work done on this branch today.

---

## Summary of Changes

### 1. Phase-Based Architecture (from PRs #5 and #6)

Merged the phase-based architecture that allows users to choose analysis depth:

| Phase | Name | Description |
|-------|------|-------------|
| `QUICK_CHECK` | Comprovació Ràpida | Fast validation: codes, units, quantities only |
| `FULL_ANALYSIS` | Anàlisi Completa | Comprehensive: all properties compared |

**Files added:**
- `src/phases/__init__.py`
- `src/phases/config.py` - Phase configuration definitions

Users select the phase via radio buttons in the UI before clicking "Generar Excel".

---

### 2. Development Environment Setup

Created a clear dual-venv setup for Mac developers:

```
┌─────────────────────┐         ┌─────────────────────────────────┐
│      venv/          │         │         venv_win/               │
│   (Mac Python)      │         │     (Wine = Windows Python)     │
│                     │         │                                 │
│  • Run tests        │         │  • Build .exe for Windows       │
│  • Development      │         │  • Uses Python inside Wine      │
│  • Build .app       │         │                                 │
└─────────────────────┘         └─────────────────────────────────┘
```

**Files added/modified:**
- `setup_dev.sh` - One-command setup script for both venvs
- `.gitignore` - Added `venv_win/`
- `BUILD.md` - Comprehensive rewrite with clear explanations

---

### 3. Wine Build Fix - Debugging & Solution

#### The Problem

When attempting to build the Windows `.exe` using Wine on Mac, the build would hang or crash during the PyInstaller analysis phase.

#### Errors Encountered

**Error 1: Build appeared stuck**
- PyInstaller would start but show 0% CPU usage
- No files were being created in `build/` directory
- Process appeared frozen

**Error 2: Wine function not implemented**
```
wine: Call from 00006FFFFFC1CF77 to unimplemented function ucrtbase.dll.crealf, aborting
wine: Unimplemented function ucrtbase.dll.crealf called at address 00006FFFFFC1CF77 (thread 0314), starting debugger...
WineDbg attached to pid 0310
```

#### Root Cause Analysis

The function `crealf()` is a C99 standard library function that returns the real part of a complex float. It's part of `ucrtbase.dll` (Universal C Runtime) on Windows.

- **numpy 2.x** (2.4.1) uses `crealf()` for complex number operations
- **Wine 10.0** does not implement this function
- When numpy tries to call `crealf()`, Wine crashes and attaches the debugger

#### The Fix

Downgrade numpy to version 1.x which doesn't use `crealf()`:

```bash
# In the Wine venv, downgrade numpy
wine venv_win/Scripts/pip.exe install "numpy<2.0" --force-reinstall

# This installs numpy 1.26.4 (latest 1.x)
```

After downgrading, also reinstall pyinstaller to fix any broken dependencies:
```bash
wine venv_win/Scripts/pip.exe install --force-reinstall pyinstaller
```

#### Result After Fix

Build completed successfully in ~55 seconds:
```
43420 INFO: Building PYZ (ZlibArchive) completed successfully.
55651 INFO: Building PKG (CArchive) ConflictFlaggerAEC.pkg completed successfully.
55898 INFO: Building EXE from EXE-00.toc completed successfully.
55921 INFO: Build complete! The results are available in: dist
```

#### Why Wine is Slow

Even with the fix, Wine builds are slower than native Windows builds because:
1. **File I/O overhead** - Every file operation goes through Wine's emulation layer
2. **ifcopenshell** - Large library with many data files to analyze (~50+ files)
3. **No UPX compression** - UPX not available in Wine, so no binary compression

---

### 4. Build Results

Successfully built Windows executable:

| File | Size | Platform |
|------|------|----------|
| `dist/ConflictFlaggerAEC.exe` | 64 MB | Windows x86-64 |

**Build command:**
```bash
wine venv_win/Scripts/pyinstaller.exe --clean --noconfirm conflict_flagger.spec
```

**Build time:** ~55 seconds on Mac via Wine

---

### 5. Tests

All 77 tests pass:

```
tests/test_bc3_parser.py    - 16 tests (BC3 file parsing)
tests/test_comparator.py    - 12 tests (Conflict comparison)
tests/test_ifc_parser.py    - 15 tests (IFC file parsing)
tests/test_main.py          - 8 tests (Integration)
tests/test_matcher.py       - 14 tests (Element matching)
tests/test_reporter.py      - 12 tests (Report generation)
```

---

## Files Changed This Session

| File | Change |
|------|--------|
| `.gitignore` | Added `venv_win/` |
| `BUILD.md` | Major rewrite with clear dual-venv docs |
| `setup_dev.sh` | New - setup script for dev environment |
| `docs/2025-01-11-session.md` | New - this file |

---

## Quick Reference

### First-time setup on Mac:
```bash
./setup_dev.sh
```

### Run tests:
```bash
source venv/bin/activate
python3 -m pytest tests/ -v
```

### Build Windows .exe (from Mac via Wine):
```bash
wine venv_win/Scripts/pyinstaller.exe --clean --noconfirm conflict_flagger.spec
# Output: dist/ConflictFlaggerAEC.exe
```

### Build Windows .exe (from Windows natively):
```powershell
# First time setup
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
pip install pyinstaller pillow tkinterdnd2

# Build
pyinstaller --clean --noconfirm conflict_flagger.spec
# Output: dist\ConflictFlaggerAEC.exe
```

**Note:** Building on Windows is faster and doesn't have the numpy version restriction.

---

## Notes for Team

- **Never commit `venv/` or `venv_win/`** - they're in `.gitignore`
- Each developer recreates venvs locally using `setup_dev.sh`
- Wine builds require numpy < 2.0 due to Wine compatibility
- Albert can build natively on Windows without Wine
